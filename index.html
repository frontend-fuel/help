<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>220kV Digital Twin Substation - Advanced Monitoring & Control System</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      overflow: hidden;
      color: #fff;
    }

    #canvas-container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }

    canvas { display: block; }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 1000;
      border-bottom: 2px solid #00ff88;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: bold;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #00ff88;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Control Panel */
    .control-panel {
      position: fixed;
      left: 20px;
      top: 80px;
      width: 300px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      z-index: 1000;
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }

    .panel-section {
      margin-bottom: 25px;
    }

    .panel-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #00ff88;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 8px;
    }

    .control-group {
      margin-bottom: 15px;
    }

    .control-label {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
      color: #ccc;
    }

    .slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #333;
      outline: none;
      -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #00ff88;
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      -moz-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #00ff88;
      cursor: pointer;
      border: none;
    }

    .btn {
      background: linear-gradient(45deg, #00ff88, #00cc6a);
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 12px;
      margin: 5px;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
    }

    .btn.active {
      background: linear-gradient(45deg, #ff6b6b, #ee5a52);
    }

    /* Data Panel */
    .data-panel {
      position: fixed;
      right: 20px;
      top: 80px;
      width: 320px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      z-index: 1000;
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }

    .data-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .data-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .data-value {
      font-size: 24px;
      font-weight: bold;
      color: #00ff88;
      margin-bottom: 5px;
    }

    .data-label {
      font-size: 12px;
      color: #ccc;
    }

    .data-unit {
      font-size: 14px;
      color: #999;
    }

    /* Equipment List */
    .equipment-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .equipment-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .equipment-item:hover {
      background: rgba(0, 255, 136, 0.1);
      border-color: #00ff88;
    }

    .equipment-item.selected {
      background: rgba(0, 255, 136, 0.2);
      border-color: #00ff88;
    }

    .equipment-name {
      font-weight: bold;
      margin-bottom: 3px;
    }

    .equipment-status {
      font-size: 11px;
      color: #00ff88;
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      transition: opacity 0.5s ease;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #00ff88;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 18px;
      margin-bottom: 10px;
    }

    .loading-progress {
      width: 300px;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      overflow: hidden;
    }

    .loading-bar {
      height: 100%;
      background: linear-gradient(90deg, #00ff88, #00cc6a);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* 3D Data Overlay Styles */
    .data-overlay {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      border: 2px solid #00ff88;
      border-radius: 12px;
      padding: 15px;
      color: white;
      font-size: 12px;
      z-index: 1500;
      min-width: 250px;
      box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
      transform: translate(-50%, -100%);
      margin-top: -10px;
      pointer-events: none;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .data-overlay.visible {
      opacity: 1;
      transform: translate(-50%, -100%) scale(1);
    }

    .data-overlay::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: #00ff88;
    }

    .overlay-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(0, 255, 136, 0.3);
    }

    .overlay-icon {
      color: #00ff88;
      font-size: 16px;
    }

    .overlay-title {
      color: #00ff88;
      font-weight: bold;
      font-size: 14px;
    }

    .overlay-data {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .overlay-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
    }

    .overlay-label {
      color: #ccc;
      font-size: 11px;
    }

    .overlay-value {
      color: #fff;
      font-weight: bold;
      font-size: 12px;
    }

    .overlay-value.warning {
      color: #ff6b6b;
    }

    .overlay-value.good {
      color: #00ff88;
    }

    .overlay-status {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #00ff88;
      animation: pulse 2s infinite;
    }

    .status-dot.warning {
      background: #ff6b6b;
    }

    /* Equipment Highlighting */
    .equipment-highlight {
      animation: equipmentGlow 2s ease-in-out infinite;
    }

    @keyframes equipmentGlow {
      0%, 100% { 
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
      }
      50% { 
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.8);
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .control-panel, .data-panel {
        width: calc(100% - 40px);
        position: relative;
        margin: 20px;
      }
      
      .header {
        flex-direction: column;
        height: auto;
        padding: 10px;
      }

      .data-overlay {
        min-width: 200px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading Digital Twin Substation...</div>
    <div class="loading-progress">
      <div class="loading-bar" id="loadingBar"></div>
    </div>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="logo">
      <i class="fas fa-bolt"></i>
      220kV Digital Twin Substation
    </div>
    <div class="status-indicator">
      <div class="status-dot"></div>
      <span>System Online</span>
      <span id="currentTime"></span>
    </div>
  </div>

  <!-- Control Panel -->
  <div class="control-panel">
    <div class="panel-section">
      <div class="panel-title"><i class="fas fa-cogs"></i> Scene Controls</div>
      
      <div class="control-group">
        <label class="control-label">Lighting Intensity</label>
        <input type="range" class="slider" id="lightIntensity" min="0" max="2" step="0.1" value="1">
      </div>
      
      <div class="control-group">
        <label class="control-label">Environment</label>
        <button class="btn" id="dayMode">Day</button>
        <button class="btn" id="nightMode">Night</button>
        <button class="btn" id="stormMode">Storm</button>
      </div>
      
      <div class="control-group">
        <label class="control-label">Camera Presets</label>
        <button class="btn" id="overviewCam">Overview</button>
        <button class="btn" id="transformerCam">Transformer</button>
        <button class="btn" id="switchgearCam">Switchgear</button>
      </div>
    </div>

    <div class="panel-section">
      <div class="panel-title"><i class="fas fa-eye"></i> Visualization</div>
      
      <div class="control-group">
        <button class="btn" id="toggleWireframe">Wireframe</button>
        <button class="btn" id="toggleShadows">Shadows</button>
        <button class="btn" id="toggleFog">Fog Effect</button>
        <button class="btn" id="forceColors">Fix Colors</button>
      </div>
      
      <div class="control-group">
        <label class="control-label">Animation Speed</label>
        <input type="range" class="slider" id="animSpeed" min="0" max="2" step="0.1" value="1">
      </div>
    </div>

    <div class="panel-section">
      <div class="panel-title"><i class="fas fa-bolt"></i> 220kV Operations</div>
      
      <div class="control-group">
        <button class="btn" id="loadFlow">Load Flow Analysis</button>
        <button class="btn" id="faultAnalysis">Fault Analysis</button>
      </div>
      
      <div class="control-group">
        <button class="btn" id="protectionTest">Protection Test</button>
        <button class="btn" id="maintenanceMode">Maintenance Mode</button>
      </div>
      
      <div class="control-group">
        <label class="control-label">Tap Position</label>
        <input type="range" class="slider" id="tapPosition" min="1" max="21" step="1" value="11">
        <span id="tapValue" style="color: #00ff88; font-size: 12px;">11/21</span>
      </div>
    </div>

    <div class="panel-section">
      <div class="panel-title"><i class="fas fa-tools"></i> Equipment</div>
      <div class="equipment-list" id="equipmentList">
        <!-- Equipment items will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Data Panel -->
  <div class="data-panel">
    <div class="panel-section">
      <div class="panel-title"><i class="fas fa-chart-line"></i> Real-time Data</div>
      
      <div class="data-grid">
        <div class="data-card">
          <div class="data-value" id="voltage">220.0</div>
          <div class="data-label">Line Voltage</div>
          <div class="data-unit">kV</div>
        </div>
        
        <div class="data-card">
          <div class="data-value" id="current">1250.5</div>
          <div class="data-label">Line Current</div>
          <div class="data-unit">A</div>
        </div>
        
        <div class="data-card">
          <div class="data-value" id="power">475.2</div>
          <div class="data-label">Active Power</div>
          <div class="data-unit">MW</div>
        </div>
        
        <div class="data-card">
          <div class="data-value" id="frequency">50.0</div>
          <div class="data-label">Frequency</div>
          <div class="data-unit">Hz</div>
        </div>
        
        <div class="data-card">
          <div class="data-value" id="temperature">65</div>
          <div class="data-label">Temperature</div>
          <div class="data-unit">°C</div>
        </div>
        
        <div class="data-card">
          <div class="data-value" id="efficiency">99.1</div>
          <div class="data-label">Transformer Efficiency</div>
          <div class="data-unit">%</div>
        </div>
        
        <div class="data-card">
          <div class="data-value" id="reactive_power">125.8</div>
          <div class="data-label">Reactive Power</div>
          <div class="data-unit">MVAr</div>
        </div>
        
        <div class="data-card">
          <div class="data-value" id="power_factor">0.97</div>
          <div class="data-label">Power Factor</div>
          <div class="data-unit">lag</div>
        </div>
        
        <div class="data-card">
          <div class="data-value" id="load_percentage">78.5</div>
          <div class="data-label">Load</div>
          <div class="data-unit">%</div>
        </div>
        
        <div class="data-card">
          <div class="data-value" id="oil_temperature">85</div>
          <div class="data-label">Oil Temp</div>
          <div class="data-unit">°C</div>
        </div>
      </div>
    </div>

    <div class="panel-section">
      <div class="panel-title"><i class="fas fa-exclamation-triangle"></i> Alerts</div>
      <div id="alertsList">
        <div style="color: #00ff88; font-size: 12px; padding: 10px; text-align: center;">
          All systems operating normally
        </div>
      </div>
    </div>

    <div class="panel-section">
      <div class="panel-title"><i class="fas fa-info-circle"></i> Selected Equipment</div>
      <div id="equipmentDetails">
        <div style="color: #ccc; font-size: 12px; padding: 10px; text-align: center;">
          Click on equipment to view details
        </div>
      </div>
    </div>
  </div>

  <!-- Canvas Container -->
  <div id="canvas-container">
    <!-- 3D Data Overlay -->
    <div class="data-overlay" id="dataOverlay">
      <div class="overlay-header">
        <i class="overlay-icon fas fa-bolt"></i>
        <span class="overlay-title" id="overlayTitle">Equipment Data</span>
      </div>
      <div class="overlay-data" id="overlayData">
        <!-- Data will be populated dynamically -->
      </div>
      <div class="overlay-status">
        <div class="status-dot" id="overlayStatusDot"></div>
        <span id="overlayStatus">Operational</span>
      </div>
    </div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
      }
    }
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // Global variables
    let scene, camera, renderer, controls, mixer, clock;
    let loadedModel, raycaster, mouse;
    let directionalLight, ambientLight, fog;
    let equipmentObjects = [];
    let selectedEquipment = null;
    let animationSpeed = 1;
    let isWireframe = false;
    let currentEnvironment = 'day';
    let dataOverlay = null;
    let hoveredEquipment = null;
    let equipmentData = new Map();
    let highlightedMesh = null;

    // Initialize the application
    init();

    function init() {
      // Scene setup
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x87ceeb); // Sky blue
      
      // Camera setup with better initial position
      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(15, 15, 15); // Better initial position
      
      // Renderer setup
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.2;
      
      // Enhanced settings for better color/texture rendering
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.physicallyCorrectLights = true;
      renderer.gammaFactor = 2.2;
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      
      const canvasContainer = document.getElementById('canvas-container');
      canvasContainer.appendChild(renderer.domElement);

      // Lighting setup
      setupLighting();
      
      // Controls setup
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.maxPolarAngle = Math.PI / 2;
      controls.minDistance = 5;
      controls.maxDistance = 50;

      // Raycaster for object selection
      raycaster = new THREE.Raycaster();
      mouse = new THREE.Vector2();

      // Clock for animations
      clock = new THREE.Clock();

      // Load the 3D model
      loadModel();
      
      // Set initial camera position after a short delay to ensure model is loaded
      setTimeout(() => {
        if (loadedModel) {
          setCameraPreset('overview');
        }
      }, 500);
      
      // Setup UI event listeners
      setupEventListeners();
      
      // Start animation loop
      animate();
      
      // Initialize real-time data simulation
      startDataSimulation();
      
      // Update time display
      updateTime();
      setInterval(updateTime, 1000);
    }

    function setupLighting() {
      // Directional light (sun) - brighter for better color visibility
      directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
      directionalLight.position.set(20, 20, 20);
      directionalLight.castShadow = true;
      directionalLight.shadow.mapSize.width = 2048;
      directionalLight.shadow.mapSize.height = 2048;
      directionalLight.shadow.camera.near = 0.5;
      directionalLight.shadow.camera.far = 100;
      directionalLight.shadow.camera.left = -20;
      directionalLight.shadow.camera.right = 20;
      directionalLight.shadow.camera.top = 20;
      directionalLight.shadow.camera.bottom = -20;
      scene.add(directionalLight);

      // Brighter ambient light to show colors better
      ambientLight = new THREE.AmbientLight(0x404040, 0.8);
      scene.add(ambientLight);

      // Additional fill lights to ensure colors are visible
      const fillLight1 = new THREE.DirectionalLight(0xffffff, 0.3);
      fillLight1.position.set(-20, 10, -20);
      scene.add(fillLight1);
      
      const fillLight2 = new THREE.DirectionalLight(0xffffff, 0.3);
      fillLight2.position.set(20, 10, -20);
      scene.add(fillLight2);

      // Hemisphere light for natural lighting
      const hemisphereLight = new THREE.HemisphereLight(0x87ceeb, 0x362d1d, 0.5);
      scene.add(hemisphereLight);
    }

    function loadModel() {
      const loader = new GLTFLoader();
      const loadingBar = document.getElementById('loadingBar');
      
      // Simulate loading progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 90) progress = 90;
        loadingBar.style.width = progress + '%';
      }, 100);

      // Add timeout fallback in case model doesn't load
      const loadTimeout = setTimeout(() => {
        console.warn('Model loading timeout - continuing without 3D model');
        clearInterval(progressInterval);
        loadingBar.style.width = '100%';
        setTimeout(() => {
          document.getElementById('loadingScreen').style.opacity = '0';
          setTimeout(() => {
            document.getElementById('loadingScreen').style.display = 'none';
          }, 500);
        }, 500);
        populateEquipmentList();
      }, 10000); // 10 second timeout

      // Use absolute path so it works from the digital-twin/ subfolder and on deployments
      loader.load('scene.gltf', 
        (gltf) => {
          clearTimeout(loadTimeout);
          loadedModel = gltf.scene;
          
          // Center the model
          const box = new THREE.Box3().setFromObject(loadedModel);
          const center = box.getCenter(new THREE.Vector3());
          const size = box.getSize(new THREE.Vector3());
          
          // Reposition model to center of scene
          loadedModel.position.x = -center.x;
          loadedModel.position.y = -center.y;
          loadedModel.position.z = -center.z;
          
          // Add the model to the scene
          scene.add(loadedModel);
          
          // Enable shadows and fix materials for all meshes
          loadedModel.traverse((child) => {
            if (child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = true;
              
              console.log('Processing mesh:', child.name, 'Material:', child.material);
              
              // AGGRESSIVE FIX: Replace all materials with colored ones
              const objectColor = getDefaultColorForObject(child.name);
              
              // Create a new material with proper color
              child.material = new THREE.MeshStandardMaterial({
                color: objectColor,
                metalness: 0.2,
                roughness: 0.8,
                side: THREE.DoubleSide // Ensure both sides are visible
              });
              
              console.log('Applied color', objectColor.toString(16), 'to', child.name);
              
              // Store equipment objects for interaction
              if (child.name.includes('transformer') || 
                  child.name.includes('switch') || 
                  child.name.includes('breaker') ||
                  child.name.includes('busbar')) {
                equipmentObjects.push({
                  object: child,
                  name: child.name,
                  type: getEquipmentType(child.name),
                  status: 'operational'
                });
              }
            }
          });

          scene.add(loadedModel);
          
          // Setup animations if available
          if (gltf.animations && gltf.animations.length > 0) {
            mixer = new THREE.AnimationMixer(loadedModel);
            gltf.animations.forEach((clip) => {
              const action = mixer.clipAction(clip);
              action.play();
            });
          }

          // Set initial camera position to show the whole model
          const maxDim = Math.max(size.x, size.y, size.z);
          const fov = camera.fov * (Math.PI / 180);
          let cameraZ = Math.abs(maxDim / Math.sin(fov / 2));
          cameraZ *= 1.5; // Add some padding
          
          camera.position.set(cameraZ, cameraZ * 0.5, cameraZ);
          controls.target.set(0, size.y * 0.5, 0); // Look at center of model
          controls.update();

          // Complete loading
          clearInterval(progressInterval);
          loadingBar.style.width = '100%';
          setTimeout(() => {
            document.getElementById('loadingScreen').style.opacity = '0';
            setTimeout(() => {
              document.getElementById('loadingScreen').style.display = 'none';
            }, 500);
          }, 500);

          // Populate equipment list
          populateEquipmentList();
        },
        (progress) => {
          // Real loading progress
          const percentComplete = (progress.loaded / progress.total) * 100;
          loadingBar.style.width = Math.min(percentComplete, 90) + '%';
        },
        (error) => {
          console.error('Error loading model:', error);
          document.querySelector('.loading-text').textContent = 'Error loading model. Please check the file path.';
        }
      );
    }

    function fixMaterial(material) {
      console.log('Fixing material:', material.name, material.type, material);
      
      // Force material update
      material.needsUpdate = true;
      
      // Handle different material types with more aggressive fixes
      if (material.isMeshStandardMaterial || material.isMeshPhysicalMaterial) {
        // Set more visible default properties
        material.metalness = material.metalness !== undefined ? material.metalness : 0.0;
        material.roughness = material.roughness !== undefined ? material.roughness : 0.8;
        
        // Force a visible color if none exists
        if (!material.color || (material.color.r === 0 && material.color.g === 0 && material.color.b === 0)) {
          material.color = new THREE.Color(0x888888); // Gray fallback
        }
        
        // If color is pure white and no texture, make it more visible
        if (material.color.r === 1 && material.color.g === 1 && material.color.b === 1 && !material.map) {
          material.color.setHex(0xaaaaaa);
        }
        
      } else if (material.isMeshLambertMaterial || material.isMeshPhongMaterial) {
        // For older materials, ensure they have color
        if (!material.color || (material.color.r === 0 && material.color.g === 0 && material.color.b === 0)) {
          material.color = new THREE.Color(0x666666);
        }
      } else if (material.isMeshBasicMaterial) {
        // Basic materials don't need lighting but should have color
        if (!material.color || (material.color.r === 0 && material.color.g === 0 && material.color.b === 0)) {
          material.color = new THREE.Color(0x777777);
        }
      }
      
      // Handle textures
      if (material.map) {
        material.map.needsUpdate = true;
        material.map.flipY = false;
        console.log('Material has texture:', material.map);
      } else {
        console.log('Material has no texture, using color:', material.color);
      }
      
      // Fix transparency issues
      if (material.transparent) {
        if (material.opacity < 0.1) {
          material.opacity = 0.9;
        }
      } else if (material.opacity !== undefined && material.opacity < 0.9) {
        material.transparent = true;
        material.opacity = Math.max(material.opacity, 0.8);
      }
      
      // Add some default colors based on material name for electrical equipment
      if (material.name) {
        const name = material.name.toLowerCase();
        if (name.includes('metal') || name.includes('steel') || name.includes('iron')) {
          material.color.setHex(0x888888);
          material.metalness = 0.8;
          material.roughness = 0.2;
        } else if (name.includes('copper') || name.includes('wire')) {
          material.color.setHex(0xb87333);
          material.metalness = 0.9;
          material.roughness = 0.1;
        } else if (name.includes('insulator') || name.includes('ceramic')) {
          material.color.setHex(0xf0f0f0);
          material.metalness = 0.0;
          material.roughness = 0.9;
        } else if (name.includes('concrete') || name.includes('ground')) {
          material.color.setHex(0x666666);
          material.metalness = 0.0;
          material.roughness = 1.0;
        }
      }
    }

    function getDefaultColorForObject(name) {
      if (!name) return 0x888888;
      
      const lowerName = name.toLowerCase();
      
      // Assign colors based on object names
      if (lowerName.includes('transformer')) return 0x4a90e2; // Blue
      if (lowerName.includes('switch') || lowerName.includes('breaker')) return 0x7ed321; // Green
      if (lowerName.includes('busbar') || lowerName.includes('bus')) return 0xf5a623; // Orange
      if (lowerName.includes('insulator')) return 0xf0f0f0; // White
      if (lowerName.includes('wire') || lowerName.includes('cable')) return 0xb87333; // Copper
      if (lowerName.includes('metal') || lowerName.includes('steel')) return 0x888888; // Gray
      if (lowerName.includes('concrete') || lowerName.includes('ground')) return 0x666666; // Dark gray
      if (lowerName.includes('support') || lowerName.includes('pole')) return 0x8b4513; // Brown
      
      // Default colors for common electrical equipment
      return 0xaaaaaa; // Light gray default
    }

    function getEquipmentType(name) {
      if (name.includes('transformer')) return 'Power Transformer';
      if (name.includes('switch')) return 'Switch';
      if (name.includes('breaker')) return 'Circuit Breaker';
      if (name.includes('busbar')) return 'Busbar';
      return 'Equipment';
    }

    function populateEquipmentList() {
      const equipmentList = document.getElementById('equipmentList');
      equipmentList.innerHTML = '';

      // Add some default equipment if none found in model
      if (equipmentObjects.length === 0) {
        const defaultEquipment = [
          { name: '220kV Main Transformer T1', type: '220kV Power Transformer', status: 'operational', rating: '300 MVA' },
          { name: '220kV Circuit Breaker CB1', type: 'SF6 Circuit Breaker', status: 'operational', rating: '3150A' },
          { name: '220kV Disconnect Switch DS1', type: 'Disconnect Switch', status: 'operational', rating: '3150A' },
          { name: '220kV Busbar Section A', type: 'Main Busbar', status: 'operational', rating: '4000A' },
          { name: '220kV Lightning Arrester LA1', type: 'Surge Arrester', status: 'operational', rating: '192kV' },
          { name: '220kV Current Transformer CT1', type: 'Current Transformer', status: 'operational', rating: '2000/5A' },
          { name: '220kV Voltage Transformer VT1', type: 'Voltage Transformer', status: 'operational', rating: '220kV/110V' },
          { name: 'Control & Protection Panel', type: 'Control System', status: 'operational', rating: 'IEC 61850' }
        ];
        
        defaultEquipment.forEach(equipment => {
          const item = document.createElement('div');
          item.className = 'equipment-item';
          item.innerHTML = `
            <div class="equipment-name">${equipment.name}</div>
            <div class="equipment-status">Status: ${equipment.status}</div>
          `;
          item.addEventListener('click', () => selectEquipment(equipment, true));
          equipmentList.appendChild(item);
        });
      } else {
        equipmentObjects.forEach(equipment => {
          const item = document.createElement('div');
          item.className = 'equipment-item';
          item.innerHTML = `
            <div class="equipment-name">${equipment.type}</div>
            <div class="equipment-status">Status: ${equipment.status}</div>
          `;
          item.addEventListener('click', () => selectEquipment(equipment, true));
          equipmentList.appendChild(item);
        });
      }
    }

    function selectEquipment(equipment, fromUI = false) {
      selectedEquipment = equipment;
      
      // Update UI only if selection came from equipment list
      if (fromUI) {
        document.querySelectorAll('.equipment-item').forEach(item => {
          item.classList.remove('selected');
        });
        if (event && event.target) {
          event.target.closest('.equipment-item').classList.add('selected');
        }
      }
      
      // Show equipment details
      showEquipmentDetails(equipment);
      
      // Focus camera on equipment if it has an object
      if (equipment.object) {
        focusOnObject(equipment.object);
      }
    }

    function showEquipmentDetails(equipment) {
      const detailsPanel = document.getElementById('equipmentDetails');
      const voltage = equipment.name.includes('220kV') ? (220 + Math.random() * 4 - 2).toFixed(1) : (Math.random() * 50 + 100).toFixed(1);
      const current = equipment.name.includes('220kV') ? (1250 + Math.random() * 200 - 100).toFixed(1) : (Math.random() * 100 + 200).toFixed(1);
      
      detailsPanel.innerHTML = `
        <div style="padding: 10px;">
          <h4 style="color: #00ff88; margin-bottom: 10px;">${equipment.name || equipment.type}</h4>
          <p><strong>Type:</strong> ${equipment.type}</p>
          <p><strong>Rating:</strong> ${equipment.rating || 'N/A'}</p>
          <p><strong>Status:</strong> <span style="color: ${equipment.status === 'operational' ? '#00ff88' : '#ff6b6b'}">${equipment.status}</span></p>
          <p><strong>Voltage:</strong> ${voltage} kV</p>
          <p><strong>Current:</strong> ${current} A</p>
          <p><strong>Temperature:</strong> ${(Math.random() * 20 + 65).toFixed(1)}°C</p>
          <p><strong>Load:</strong> ${(Math.random() * 30 + 70).toFixed(1)}%</p>
          <p><strong>Last Maintenance:</strong> ${new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toLocaleDateString()}</p>
          <p><strong>Next Maintenance:</strong> ${new Date(Date.now() + Math.random() * 60 * 24 * 60 * 60 * 1000).toLocaleDateString()}</p>
        </div>
      `;
    }

    function focusOnObject(object) {
      console.log('Focusing on object:', object.name);
      
      // Get object world position
      const box = new THREE.Box3().setFromObject(object);
      const center = box.getCenter(new THREE.Vector3());
      const size = box.getSize(new THREE.Vector3());
      
      console.log('Object center:', center);
      console.log('Object size:', size);
      
      // If object has no size or is at origin, try to get position from object directly
      if (size.length() < 0.1 || (center.x === 0 && center.y === 0 && center.z === 0)) {
        console.log('Object has no size or is at origin, using object position');
        object.getWorldPosition(center);
        console.log('World position:', center);
      }
      
      // Calculate appropriate distance based on object size
      const maxDimension = Math.max(size.x, size.y, size.z);
      let distance = Math.max(maxDimension * 4, 15); // Minimum distance of 15 units
      
      // If object is very small or has no size, use a reasonable default distance
      if (maxDimension < 1) {
        distance = 20;
      }
      
      // Calculate camera position - position camera at an angle for better view
      const targetPosition = new THREE.Vector3(
        center.x + distance * 0.8,  // Offset to the right
        center.y + distance * 0.6,  // Offset upward  
        center.z + distance * 0.8   // Offset forward
      );
      
      // Ensure camera doesn't go too close to the ground
      targetPosition.y = Math.max(targetPosition.y, 5);
      
      console.log('Target camera position:', targetPosition);
      console.log('Look at target:', center);
      
      // Animate camera movement
      animateCamera(targetPosition, center);
    }

    function animateCamera(targetPosition, lookAtTarget) {
      const startPosition = camera.position.clone();
      const startTarget = controls.target.clone();
      
      let progress = 0;
      const duration = 2000; // 2 seconds
      const startTime = Date.now();
      
      function updateCamera() {
        const elapsed = Date.now() - startTime;
        progress = Math.min(elapsed / duration, 1);
        
        // Smooth easing
        const eased = 1 - Math.pow(1 - progress, 3);
        
        camera.position.lerpVectors(startPosition, targetPosition, eased);
        controls.target.lerpVectors(startTarget, lookAtTarget, eased);
        controls.update();
        
        if (progress < 1) {
          requestAnimationFrame(updateCamera);
        }
      }
      
      updateCamera();
    }

    function setupEventListeners() {
      // Lighting intensity control
      document.getElementById('lightIntensity').addEventListener('input', (e) => {
        const intensity = parseFloat(e.target.value);
        directionalLight.intensity = intensity;
        ambientLight.intensity = intensity * 0.4;
      });

      // Environment controls
      document.getElementById('dayMode').addEventListener('click', () => setEnvironment('day'));
      document.getElementById('nightMode').addEventListener('click', () => setEnvironment('night'));
      document.getElementById('stormMode').addEventListener('click', () => setEnvironment('storm'));

      // Camera presets
      document.getElementById('overviewCam').addEventListener('click', () => setCameraPreset('overview'));
      document.getElementById('transformerCam').addEventListener('click', () => setCameraPreset('transformer'));
      document.getElementById('switchgearCam').addEventListener('click', () => setCameraPreset('switchgear'));

      // Visualization toggles
      document.getElementById('toggleWireframe').addEventListener('click', toggleWireframe);
      document.getElementById('toggleShadows').addEventListener('click', toggleShadows);
      document.getElementById('toggleFog').addEventListener('click', toggleFog);
      document.getElementById('forceColors').addEventListener('click', forceApplyColors);

      // Animation speed
      document.getElementById('animSpeed').addEventListener('input', (e) => {
        animationSpeed = parseFloat(e.target.value);
      });

      // 220kV Operations controls
      document.getElementById('loadFlow').addEventListener('click', performLoadFlowAnalysis);
      document.getElementById('faultAnalysis').addEventListener('click', performFaultAnalysis);
      document.getElementById('protectionTest').addEventListener('click', performProtectionTest);
      document.getElementById('maintenanceMode').addEventListener('click', toggleMaintenanceMode);
      
      // Tap position control
      document.getElementById('tapPosition').addEventListener('input', (e) => {
        const tapValue = e.target.value;
        document.getElementById('tapValue').textContent = `${tapValue}/21`;
        // Simulate voltage adjustment based on tap position
        const baseVoltage = 220;
        const voltageAdjustment = (tapValue - 11) * 1.25; // ±1.25% per tap
        const adjustedVoltage = baseVoltage + voltageAdjustment;
        document.getElementById('voltage').textContent = adjustedVoltage.toFixed(1);
      });

      // Mouse interaction for object selection and hover
      renderer.domElement.addEventListener('click', onMouseClick);
      renderer.domElement.addEventListener('mousemove', onMouseMove);
      renderer.domElement.addEventListener('mouseleave', onMouseLeave);
      
      // Window resize
      window.addEventListener('resize', onWindowResize);
      
      // Initialize data overlay
      dataOverlay = document.getElementById('dataOverlay');
    }

    function setEnvironment(mode) {
      currentEnvironment = mode;
      
      // Update button states
      document.querySelectorAll('#dayMode, #nightMode, #stormMode').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(mode + 'Mode').classList.add('active');

      switch (mode) {
        case 'day':
          scene.background = new THREE.Color(0x87ceeb);
          directionalLight.color.setHex(0xffffff);
          directionalLight.intensity = 1;
          ambientLight.intensity = 0.4;
          if (fog) scene.remove(fog);
          break;
          
        case 'night':
          scene.background = new THREE.Color(0x191970);
          directionalLight.color.setHex(0x4169e1);
          directionalLight.intensity = 0.3;
          ambientLight.intensity = 0.1;
          if (fog) scene.remove(fog);
          break;
          
        case 'storm':
          scene.background = new THREE.Color(0x2f4f4f);
          directionalLight.color.setHex(0x708090);
          directionalLight.intensity = 0.5;
          ambientLight.intensity = 0.2;
          
          // Add fog effect
          fog = new THREE.Fog(0x2f4f4f, 10, 100);
          scene.fog = fog;
          
          // Add lightning effect occasionally
          setInterval(() => {
            if (currentEnvironment === 'storm' && Math.random() < 0.1) {
              directionalLight.intensity = 2;
              setTimeout(() => {
                if (currentEnvironment === 'storm') {
                  directionalLight.intensity = 0.5;
                }
              }, 100);
            }
          }, 3000);
          break;
      }
    }

    function setCameraPreset(preset) {
      let targetPosition, lookAtTarget;
      
      // Get model bounding box if available
      let modelCenter = new THREE.Vector3();
      let modelSize = new THREE.Vector3(1, 1, 1);
      
      if (loadedModel) {
        const box = new THREE.Box3().setFromObject(loadedModel);
        box.getCenter(modelCenter);
        box.getSize(modelSize);
      }
      
      // Adjust camera positions relative to model
      switch (preset) {
        case 'overview':
          const maxDim = Math.max(modelSize.x, modelSize.y, modelSize.z);
          const distance = maxDim * 1.5;
          targetPosition = new THREE.Vector3(
            modelCenter.x + distance,
            modelCenter.y + distance * 0.7,
            modelCenter.z + distance
          );
          lookAtTarget = modelCenter.clone();
          break;
          
        case 'transformer':
          targetPosition = new THREE.Vector3(
            modelCenter.x + 5,
            modelCenter.y + 3,
            modelCenter.z + 8
          );
          lookAtTarget = new THREE.Vector3(modelCenter.x, modelCenter.y + 2, modelCenter.z);
          break;
          
        case 'switchgear':
          targetPosition = new THREE.Vector3(
            modelCenter.x - 5,
            modelCenter.y + 2,
            modelCenter.z + 5
          );
          lookAtTarget = new THREE.Vector3(modelCenter.x - 2, modelCenter.y, modelCenter.z);
          break;
      }
      
      animateCamera(targetPosition, lookAtTarget);
    }

    function toggleWireframe() {
      isWireframe = !isWireframe;
      document.getElementById('toggleWireframe').classList.toggle('active');
      
      if (loadedModel) {
        loadedModel.traverse((child) => {
          if (child.isMesh) {
            child.material.wireframe = isWireframe;
          }
        });
      }
    }

    function toggleShadows() {
      renderer.shadowMap.enabled = !renderer.shadowMap.enabled;
      document.getElementById('toggleShadows').classList.toggle('active');
    }

    function toggleFog() {
      if (scene.fog) {
        scene.fog = null;
        document.getElementById('toggleFog').classList.remove('active');
      } else {
        scene.fog = new THREE.Fog(0x87ceeb, 20, 100);
        document.getElementById('toggleFog').classList.add('active');
      }
    }

    function forceApplyColors() {
      console.log('Manually applying colors to all objects...');
      
      if (loadedModel) {
        loadedModel.traverse((child) => {
          if (child.isMesh) {
            const objectColor = getDefaultColorForObject(child.name);
            
            // Create a bright, visible material
            child.material = new THREE.MeshStandardMaterial({
              color: objectColor,
              metalness: 0.1,
              roughness: 0.9,
              side: THREE.DoubleSide
            });
            
            console.log('Force applied color', objectColor.toString(16), 'to', child.name);
          }
        });
        
        // Also try creating some test colored cubes if model is still white
        createTestObjects();
      }
    }

    function createTestObjects() {
      // Create some test colored objects to verify colors are working
      const testGeometry = new THREE.BoxGeometry(2, 2, 2);
      
      const colors = [0xff0000, 0x00ff00, 0x0000ff, 0xffff00, 0xff00ff, 0x00ffff];
      
      colors.forEach((color, index) => {
        const testMaterial = new THREE.MeshStandardMaterial({ color: color });
        const testCube = new THREE.Mesh(testGeometry, testMaterial);
        testCube.position.set((index - 2.5) * 5, 5, 0);
        testCube.name = `TestCube_${index}`;
        scene.add(testCube);
      });
      
      console.log('Added test colored cubes above the model');
    }

    function onMouseClick(event) {
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      
      if (loadedModel) {
        const intersects = raycaster.intersectObjects(loadedModel.children, true);
        
        if (intersects.length > 0) {
          const clickedObject = intersects[0].object;
          const intersectionPoint = intersects[0].point;
          
          // Find equipment data for clicked object
          let equipment = equipmentObjects.find(eq => eq.object === clickedObject);
          
          // If not found in equipment objects, create one based on object name
          if (!equipment && clickedObject.name) {
            equipment = createEquipmentFromObject(clickedObject);
          }
          
          if (equipment) {
            selectEquipment(equipment, false); // false = not from UI
            showDataOverlay(equipment, event.clientX, event.clientY);
            highlightEquipment(clickedObject);
            
            // Additional focus call with delay to ensure proper positioning
            setTimeout(() => {
              if (equipment.object) {
                focusOnObject(equipment.object);
              }
            }, 100);
          }
        } else {
          // Clicked on empty space, hide overlay
          hideDataOverlay();
          clearHighlight();
        }
      }
    }

    function onMouseMove(event) {
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      
      if (loadedModel) {
        const intersects = raycaster.intersectObjects(loadedModel.children, true);
        
        if (intersects.length > 0) {
          const hoveredObject = intersects[0].object;
          
          // Change cursor to pointer when hovering over equipment
          if (isEquipmentObject(hoveredObject)) {
            renderer.domElement.style.cursor = 'pointer';
            
            // Show quick preview tooltip
            if (hoveredEquipment !== hoveredObject) {
              hoveredEquipment = hoveredObject;
              showQuickPreview(hoveredObject, event.clientX, event.clientY);
            }
          } else {
            renderer.domElement.style.cursor = 'default';
            hoveredEquipment = null;
          }
        } else {
          renderer.domElement.style.cursor = 'default';
          hoveredEquipment = null;
        }
      }
    }

    function onMouseLeave() {
      renderer.domElement.style.cursor = 'default';
      hoveredEquipment = null;
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function startDataSimulation() {
      setInterval(() => {
        // Simulate real-time data updates for 220kV system
        document.getElementById('voltage').textContent = (220 + Math.random() * 4 - 2).toFixed(1);
        document.getElementById('current').textContent = (1250 + Math.random() * 100 - 50).toFixed(1);
        document.getElementById('power').textContent = (475 + Math.random() * 20 - 10).toFixed(1);
        document.getElementById('frequency').textContent = (50.0 + Math.random() * 0.1 - 0.05).toFixed(2);
        document.getElementById('temperature').textContent = (65 + Math.random() * 4 - 2).toFixed(0);
        document.getElementById('efficiency').textContent = (99.1 + Math.random() * 0.4 - 0.2).toFixed(1);
        document.getElementById('reactive_power').textContent = (125 + Math.random() * 10 - 5).toFixed(1);
        document.getElementById('power_factor').textContent = (0.97 + Math.random() * 0.04 - 0.02).toFixed(2);
        document.getElementById('load_percentage').textContent = (78 + Math.random() * 10 - 5).toFixed(1);
        document.getElementById('oil_temperature').textContent = (85 + Math.random() * 6 - 3).toFixed(0);
        
        // Occasionally generate alerts
        if (Math.random() < 0.05) {
          generateAlert();
        }
      }, 2000);
    }

    function generateAlert() {
      const alerts = [
        { type: 'warning', message: '220kV Transformer T1: Oil temperature above 90°C' },
        { type: 'info', message: '220kV Circuit Breaker CB1: Scheduled maintenance in 7 days' },
        { type: 'warning', message: '220kV Busbar: Voltage deviation +2.5% detected' },
        { type: 'info', message: '220kV System: Load balancing optimization completed' },
        { type: 'warning', message: '220kV Line: Power factor below 0.95 detected' },
        { type: 'info', message: 'Protection System: IEC 61850 communication normal' },
        { type: 'warning', message: '220kV CT1: Current imbalance detected' },
        { type: 'info', message: 'SCADA System: Data acquisition rate optimal' }
      ];
      
      const alert = alerts[Math.floor(Math.random() * alerts.length)];
      const alertsList = document.getElementById('alertsList');
      
      const alertElement = document.createElement('div');
      alertElement.style.cssText = `
        padding: 8px;
        margin: 5px 0;
        border-radius: 5px;
        font-size: 11px;
        background: ${alert.type === 'warning' ? 'rgba(255, 107, 107, 0.2)' : 'rgba(0, 255, 136, 0.2)'};
        border-left: 3px solid ${alert.type === 'warning' ? '#ff6b6b' : '#00ff88'};
      `;
      alertElement.textContent = alert.message;
      
      alertsList.appendChild(alertElement);
      
      // Remove old alerts
      if (alertsList.children.length > 3) {
        alertsList.removeChild(alertsList.firstChild);
      }
    }

    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleTimeString();
    }

    // 220kV Operations Functions
    function performLoadFlowAnalysis() {
      const alertsList = document.getElementById('alertsList');
      const alertElement = document.createElement('div');
      alertElement.style.cssText = `
        padding: 8px;
        margin: 5px 0;
        border-radius: 5px;
        font-size: 11px;
        background: rgba(0, 255, 136, 0.2);
        border-left: 3px solid #00ff88;
      `;
      alertElement.textContent = 'Load Flow Analysis: All buses within voltage limits. Power flow stable.';
      alertsList.appendChild(alertElement);
      
      // Highlight the button temporarily
      document.getElementById('loadFlow').classList.add('active');
      setTimeout(() => {
        document.getElementById('loadFlow').classList.remove('active');
      }, 2000);
    }

    function performFaultAnalysis() {
      const alertsList = document.getElementById('alertsList');
      const alertElement = document.createElement('div');
      alertElement.style.cssText = `
        padding: 8px;
        margin: 5px 0;
        border-radius: 5px;
        font-size: 11px;
        background: rgba(255, 193, 7, 0.2);
        border-left: 3px solid #ffc107;
      `;
      alertElement.textContent = 'Fault Analysis: System protection coordination verified. No critical faults detected.';
      alertsList.appendChild(alertElement);
      
      document.getElementById('faultAnalysis').classList.add('active');
      setTimeout(() => {
        document.getElementById('faultAnalysis').classList.remove('active');
      }, 2000);
    }

    function performProtectionTest() {
      const alertsList = document.getElementById('alertsList');
      const alertElement = document.createElement('div');
      alertElement.style.cssText = `
        padding: 8px;
        margin: 5px 0;
        border-radius: 5px;
        font-size: 11px;
        background: rgba(0, 255, 136, 0.2);
        border-left: 3px solid #00ff88;
      `;
      alertElement.textContent = 'Protection Test: All protection relays responding correctly. IEC 61850 GOOSE messages OK.';
      alertsList.appendChild(alertElement);
      
      document.getElementById('protectionTest').classList.add('active');
      setTimeout(() => {
        document.getElementById('protectionTest').classList.remove('active');
      }, 2000);
    }

    let maintenanceMode = false;
    function toggleMaintenanceMode() {
      maintenanceMode = !maintenanceMode;
      const button = document.getElementById('maintenanceMode');
      
      if (maintenanceMode) {
        button.classList.add('active');
        button.textContent = 'Exit Maintenance';
        
        // Simulate maintenance mode effects
        document.getElementById('power').textContent = '0.0';
        document.getElementById('current').textContent = '0.0';
        
        const alertsList = document.getElementById('alertsList');
        const alertElement = document.createElement('div');
        alertElement.style.cssText = `
          padding: 8px;
          margin: 5px 0;
          border-radius: 5px;
          font-size: 11px;
          background: rgba(255, 107, 107, 0.2);
          border-left: 3px solid #ff6b6b;
        `;
        alertElement.textContent = 'MAINTENANCE MODE: 220kV System isolated. All circuits de-energized.';
        alertsList.appendChild(alertElement);
      } else {
        button.classList.remove('active');
        button.textContent = 'Maintenance Mode';
        
        const alertsList = document.getElementById('alertsList');
        const alertElement = document.createElement('div');
        alertElement.style.cssText = `
          padding: 8px;
          margin: 5px 0;
          border-radius: 5px;
          font-size: 11px;
          background: rgba(0, 255, 136, 0.2);
          border-left: 3px solid #00ff88;
        `;
        alertElement.textContent = 'OPERATIONAL MODE: 220kV System re-energized. Normal operation resumed.';
        alertsList.appendChild(alertElement);
      }
    }

    // Equipment Data Management
    function createEquipmentFromObject(object) {
      const equipment = {
        object: object,
        name: object.name || 'Unknown Equipment',
        type: getEquipmentType(object.name),
        status: 'operational',
        id: object.uuid
      };
      
      // Generate realistic data for this equipment
      equipmentData.set(equipment.id, generateEquipmentData(equipment));
      
      return equipment;
    }

    function generateEquipmentData(equipment) {
      const baseData = {
        voltage: 220 + Math.random() * 4 - 2,
        current: 1250 + Math.random() * 200 - 100,
        temperature: 65 + Math.random() * 10 - 5,
        power: 475 + Math.random() * 20 - 10,
        efficiency: 99.1 + Math.random() * 0.8 - 0.4,
        load: 78 + Math.random() * 15 - 7.5,
        lastUpdate: new Date()
      };

      // Customize data based on equipment type
      if (equipment.type.includes('Transformer')) {
        baseData.oilTemperature = 85 + Math.random() * 10 - 5;
        baseData.tapPosition = Math.floor(Math.random() * 21) + 1;
        baseData.insulationResistance = 1000 + Math.random() * 500;
      } else if (equipment.type.includes('Breaker')) {
        baseData.operationCount = Math.floor(Math.random() * 1000) + 500;
        baseData.contactResistance = 0.1 + Math.random() * 0.05;
        baseData.sf6Pressure = 6.5 + Math.random() * 0.5 - 0.25;
      } else if (equipment.type.includes('Switch')) {
        baseData.position = Math.random() > 0.5 ? 'Open' : 'Closed';
        baseData.operationTime = 50 + Math.random() * 20;
      }

      return baseData;
    }

    function updateEquipmentData() {
      // Update all equipment data with realistic variations
      equipmentData.forEach((data, id) => {
        data.voltage += (Math.random() - 0.5) * 0.5;
        data.current += (Math.random() - 0.5) * 10;
        data.temperature += (Math.random() - 0.5) * 1;
        data.power = (data.voltage * data.current * Math.sqrt(3)) / 1000; // P = √3 * V * I / 1000
        data.load += (Math.random() - 0.5) * 2;
        data.lastUpdate = new Date();
        
        // Keep values within realistic ranges
        data.voltage = Math.max(210, Math.min(230, data.voltage));
        data.current = Math.max(1000, Math.min(1500, data.current));
        data.temperature = Math.max(55, Math.min(85, data.temperature));
        data.load = Math.max(60, Math.min(95, data.load));
      });
    }

    function isEquipmentObject(object) {
      if (!object.name) return false;
      const name = object.name.toLowerCase();
      return name.includes('transformer') || 
             name.includes('switch') || 
             name.includes('breaker') ||
             name.includes('busbar') ||
             name.includes('ct') ||
             name.includes('vt') ||
             name.includes('arrester') ||
             name.includes('isolator');
    }

    function showDataOverlay(equipment, x, y) {
      if (!dataOverlay) return;
      
      const data = equipmentData.get(equipment.id) || generateEquipmentData(equipment);
      
      // Update overlay content
      document.getElementById('overlayTitle').textContent = equipment.name || equipment.type;
      
      const overlayData = document.getElementById('overlayData');
      overlayData.innerHTML = `
        <div class="overlay-item">
          <span class="overlay-label">Voltage:</span>
          <span class="overlay-value ${data.voltage > 225 || data.voltage < 215 ? 'warning' : 'good'}">${data.voltage.toFixed(1)} kV</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">Current:</span>
          <span class="overlay-value ${data.current > 1400 ? 'warning' : 'good'}">${data.current.toFixed(0)} A</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">Temperature:</span>
          <span class="overlay-value ${data.temperature > 75 ? 'warning' : 'good'}">${data.temperature.toFixed(1)}°C</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">Load:</span>
          <span class="overlay-value ${data.load > 90 ? 'warning' : 'good'}">${data.load.toFixed(1)}%</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">Power:</span>
          <span class="overlay-value">${data.power.toFixed(1)} MW</span>
        </div>
        <div class="overlay-item">
          <span class="overlay-label">Efficiency:</span>
          <span class="overlay-value ${data.efficiency < 98 ? 'warning' : 'good'}">${data.efficiency.toFixed(1)}%</span>
        </div>
      `;
      
      // Add equipment-specific data
      if (data.oilTemperature) {
        overlayData.innerHTML += `
          <div class="overlay-item">
            <span class="overlay-label">Oil Temp:</span>
            <span class="overlay-value ${data.oilTemperature > 90 ? 'warning' : 'good'}">${data.oilTemperature.toFixed(1)}°C</span>
          </div>
          <div class="overlay-item">
            <span class="overlay-label">Tap Position:</span>
            <span class="overlay-value">${data.tapPosition}/21</span>
          </div>
        `;
      }
      
      if (data.sf6Pressure) {
        overlayData.innerHTML += `
          <div class="overlay-item">
            <span class="overlay-label">SF6 Pressure:</span>
            <span class="overlay-value ${data.sf6Pressure < 6.0 ? 'warning' : 'good'}">${data.sf6Pressure.toFixed(1)} bar</span>
          </div>
        `;
      }
      
      if (data.position) {
        overlayData.innerHTML += `
          <div class="overlay-item">
            <span class="overlay-label">Position:</span>
            <span class="overlay-value">${data.position}</span>
          </div>
        `;
      }
      
      // Update status
      const hasWarnings = data.voltage > 225 || data.voltage < 215 || 
                         data.current > 1400 || data.temperature > 75 || 
                         data.load > 90 || data.efficiency < 98;
      
      const statusDot = document.getElementById('overlayStatusDot');
      const statusText = document.getElementById('overlayStatus');
      
      if (hasWarnings) {
        statusDot.className = 'status-dot warning';
        statusText.textContent = 'Warning - Check Parameters';
        statusText.style.color = '#ff6b6b';
      } else {
        statusDot.className = 'status-dot';
        statusText.textContent = 'Operational - All Normal';
        statusText.style.color = '#00ff88';
      }
      
      // Position overlay near click point
      dataOverlay.style.left = Math.min(x, window.innerWidth - 280) + 'px';
      dataOverlay.style.top = Math.max(y - 200, 80) + 'px';
      
      // Show overlay
      dataOverlay.classList.add('visible');
    }

    function hideDataOverlay() {
      if (dataOverlay) {
        dataOverlay.classList.remove('visible');
      }
    }

    function showQuickPreview(object, x, y) {
      // Quick preview functionality can be added here
      // For now, we'll just change the cursor
    }

    function highlightEquipment(mesh) {
      // Clear previous highlight
      clearHighlight();
      
      // Store original material
      if (mesh.material) {
        mesh.userData.originalMaterial = mesh.material;
        
        // Create highlight material
        const highlightMaterial = mesh.material.clone();
        highlightMaterial.emissive = new THREE.Color(0x00ff88);
        highlightMaterial.emissiveIntensity = 0.3;
        
        mesh.material = highlightMaterial;
        highlightedMesh = mesh;
      }
    }

    function clearHighlight() {
      if (highlightedMesh && highlightedMesh.userData.originalMaterial) {
        highlightedMesh.material = highlightedMesh.userData.originalMaterial;
        highlightedMesh = null;
      }
    }

    function animate() {
      requestAnimationFrame(animate);
      
      const delta = clock.getDelta();
      
      // Update animations
      if (mixer) {
        mixer.update(delta * animationSpeed);
      }
      
      // Update equipment data periodically
      if (Math.random() < 0.01) { // Update roughly every 100 frames
        updateEquipmentData();
      }
      
      // Update controls
      controls.update();
      
      // Render scene
      renderer.render(scene, camera);
    }

    // Initialize default environment
    setTimeout(() => {
      setEnvironment('day');
    }, 1000);
  </script>
</body>
</html>
